<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unlimited Flex Secret | Script Manager</title>
<style>
  body {
    font-family: monospace;
    background: #000;
    color: #0f0;
    margin: 0; padding: 20px;
    user-select: none;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 0 0 10px #0f0;
  }
  #welcome {
    text-align: center;
    margin-bottom: 25px;
    font-weight: bold;
  }
  button {
    cursor: pointer;
    background: #00ff00;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    margin: 5px;
    font-weight: bold;
    box-shadow: 0 0 15px #0f0;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #0f0;
  }
  button.danger {
    background: #ff3300;
    box-shadow: 0 0 15px #f00;
    color: black;
  }
  button.danger:hover {
    background: #f00;
    box-shadow: 0 0 25px #f00;
  }
  #logoutBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 75px;
    padding: 6px 10px;
    font-size: 14px;
    box-shadow: 0 0 12px #0f0;
  }
  #createScriptBtn {
    display: block;
    margin: 0 auto 20px auto;
    width: 140px;
  }
  #scriptsList {
    max-width: 600px;
    margin: 0 auto;
  }
  .scriptCard {
    background: #111;
    border: 1px solid #0f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px #0f0 inset;
  }
  .scriptHeader {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 8px;
  }
  .scriptOwner {
    font-size: 12px;
    color: #0a0;
    margin-bottom: 12px;
  }
  .buttonsRow {
    text-align: right;
  }
  #modalOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  #modal {
    background: #111;
    padding: 25px 30px;
    border-radius: 12px;
    width: 380px;
    color: #0f0;
    box-shadow: 0 0 30px #0f0;
  }
  #modal h2 {
    margin-top: 0;
    margin-bottom: 15px;
    text-align: center;
  }
  #modal input[type="text"], #modal textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    background: #222;
    border: none;
    border-radius: 6px;
    color: #0f0;
    font-weight: bold;
    font-family: monospace;
    font-size: 14px;
    resize: vertical;
  }
  #modal textarea {
    height: 100px;
  }
  #modal button {
    width: 100%;
    padding: 12px;
    font-weight: bold;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #00ff00;
    color: black;
    box-shadow: 0 0 20px #0f0;
    transition: background 0.3s ease;
  }
  #modal button:hover {
    background: #0f0;
  }
  #modalCloseBtn {
    margin-top: 10px;
    background: #ff3300;
    box-shadow: 0 0 15px #f00;
  }
  #modalCloseBtn:hover {
    background: #f00;
    box-shadow: 0 0 25px #f00;
  }
  #generatedKeyArea {
    background: #000;
    border: 1px solid #0f0;
    padding: 12px;
    margin-top: 15px;
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: inset 0 0 10px #0f0;
  }
  @media (max-width: 450px) {
    #modal {
      width: 90%;
    }
  }
</style>
</head>
<body>
<h1>Unlimited Flex Script Manager</h1>
<div id="welcome"></div>
<button id="createScriptBtn">Create New Script</button>
<div id="scriptsList"></div>
<button id="logoutBtn">Logout</button>

<!-- Modal -->
<div id="modalOverlay">
  <div id="modal">
    <h2 id="modalTitle">Create Script</h2>
    <input type="text" id="modalScriptName" placeholder="Script Name (no spaces)" />
    <textarea id="modalRequireScript" placeholder='Require script, e.g. require(12345).load("user") or require(12345)("user", "arg")'></textarea>
    <button id="modalGenerateKeyBtn">Generate Key</button>
    <button id="modalSaveScriptBtn" style="display:none;">Save Changes</button>
    <button id="modalDeleteScriptBtn" class="danger" style="display:none;">Delete Script</button>
    <button id="modalCloseBtn">Close</button>
    <pre id="generatedKeyArea" style="display:none;"></pre>
  </div>
</div>

<script>
(() => {
  const loggedInUser = localStorage.getItem('loggedInUser');
  if (!loggedInUser) {
    window.location.href = 'index.html';
    return;
  }
  document.getElementById('welcome').textContent = `Logged in as: ${loggedInUser}`;

  const STORAGE_KEY = 'flexScripts';

  function loadScripts() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch {
      return [];
    }
  }

  function saveScripts(scripts) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(scripts));
  }

  function xorEncode(str, key) {
    let result = '';
    for (let i = 0; i < str.length; i++) {
      const code = str.charCodeAt(i) ^ key.charCodeAt(i % key.length);
      result += code.toString(16).padStart(2, '0');
    }
    return result;
  }

  function splitIntoParts(hexStr) {
    const partLength = Math.ceil(hexStr.length / 6);
    const parts = [];
    for (let i = 0; i < 6; i++) {
      parts.push(hexStr.slice(i * partLength, (i + 1) * partLength));
    }
    return parts;
  }

  function generateLuaScript(name, requireStr, username) {
    const key = username;
    const encoded = xorEncode(requireStr, key);
    const parts = splitIntoParts(encoded);

    const luaXorFunc = `
local function xorDecode(hex, key)
  local function fromHex(h) return tonumber(h, 16) end
  local result = {}
  for i = 1, #hex, 2 do
    local byte = fromHex(hex:sub(i, i+1))
    local k = key:byte(((i+1)//2 - 1) % #key + 1)
    result[#result+1] = string.char(bit32.bxor(byte, k))
  end
  return table.concat(result)
end
`;

    let luaParts = '';
    parts.forEach((p, i) => {
      luaParts += `local p${i+1} = "${p}"\n`;
    });

    const concatParts = 'p1 .. p2 .. p3 .. p4 .. p5 .. p6';

    return `${luaXorFunc}
${luaParts}
local encodedStr = ${concatParts}
local requireStr = xorDecode(encodedStr, "${key}")

local DataStoreService = game:GetService("DataStoreService")
local store = DataStoreService:GetDataStore("OneTimeKeys")

local keyName = "${username}_" .. "${name}"

local success, alreadyUsed = pcall(function()
  return store:GetAsync(keyName)
end)

if success and alreadyUsed then
  error("Key already used, script locked!")
end

success, err = pcall(function()
  store:SetAsync(keyName, true)
end)

if not success then
  error("Failed to lock the key: " .. tostring(err))
end

local requireCall, methodCall, argsStr = requireStr:match("^(require%([^%)]+%))(%.?%a+)?%((.*)%)$")

local function execRequire()
  local func = loadstring("return " .. requireCall)()
  if methodCall and methodCall ~= "" then
    methodCall = methodCall:gsub("^%.", "")
    local methodFunc = func[methodCall] or func[methodCall:lower()]
    if not methodFunc then
      error("Method '" .. methodCall .. "' not found")
    end
    local args = {}
    for arg in argsStr:gmatch('\\"([^\\"]*)\\"') do
      table.insert(args, arg)
    end
    return methodFunc(table.unpack(args))
  else
    local args = {}
    for arg in argsStr:gmatch('\\"([^\\"]*)\\"') do
      table.insert(args, arg)
    end
    return func(table.unpack(args))
  end
end

return execRequire()
`;
  }

  const scriptsList = document.getElementById('scriptsList');
  const createScriptBtn = document.getElementById('createScriptBtn');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalScriptName = document.getElementById('modalScriptName');
  const modalRequireScript = document.getElementById('modalRequireScript');
  const modalGenerateKeyBtn = document.getElementById('modalGenerateKeyBtn');
  const modalSaveScriptBtn = document.getElementById('modalSaveScriptBtn');
  const modalDeleteScriptBtn = document.getElementById('modalDeleteScriptBtn');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const generatedKeyArea = document.getElementById('generatedKeyArea');

  let editingScriptId = null;

  function renderScripts() {
    const scripts = loadScripts();
    if (scripts.length === 0) {
      scriptsList.innerHTML = '<p style="text-align:center; color:#050;">No scripts created yet. Click "Create New Script" to start!</p>';
      return;
    }
    scriptsList.innerHTML = '';
    scripts.forEach((script, idx) => {
      const card = document.createElement('div');
      card.className = 'scriptCard';
      card.dataset.id = idx;

      const header = document.createElement('div');
      header.className = 'scriptHeader';
      header.textContent = script.name;
      card.appendChild(header);

      const owner = document.createElement('div');
      owner.className = 'scriptOwner';
      owner.textContent = `Owner: ${script.owner}`;
      card.appendChild(owner);

      const buttonsRow = document.createElement('div');
      buttonsRow.className = 'buttonsRow';

      const generateBtn = document.createElement('button');
      generateBtn.textContent = 'Generate Key';
      generateBtn.addEventListener('click', () => {
        const luaScript = generateLuaScript(script.name, script.requireScript, loggedInUser);
        generatedKeyArea.textContent = luaScript;
        generatedKeyArea.style.display = 'block';
        navigator.clipboard.writeText(luaScript).then(() => {
          alert('Key generated and copied to clipboard!');
        }).catch(() => {
          alert('Key generated! Copy manually.');
        });
      });
      buttonsRow.appendChild(generateBtn);

      if (script.owner === loggedInUser) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.style.marginLeft = '8px';
        editBtn.addEventListener('click', () => {
          editingScriptId = idx;
          modalTitle.textContent = 'Edit Script';
          modalScriptName.value = script.name;
          modalRequireScript.value = script.requireScript;
          modalGenerateKeyBtn.style.display = 'none';
          modalSaveScriptBtn.style.display = 'block';
          modalDeleteScriptBtn.style.display = 'block';
          generatedKeyArea.style.display = 'none';
          modalOverlay.style.display = 'flex';
        });
        buttonsRow.appendChild(editBtn);
      }

      card.appendChild(buttonsRow);
      scriptsList.appendChild(card);
    });
  }

  createScriptBtn.addEventListener('click', () => {
    editingScriptId = null;
    modalTitle.textContent = 'Create Script';
    modalScriptName.value = '';
    modalRequireScript.value = '';
    modalGenerateKeyBtn.style.display = 'block';
    modalSaveScriptBtn.style.display = 'none';
    modalDeleteScriptBtn.style.display = 'none';
    generatedKeyArea.style.display = 'none';
    modalOverlay.style.display = 'flex';
  });

  modalCloseBtn.addEventListener('click', () => {
    modalOverlay.style.display = 'none';
  });

  modalGenerateKeyBtn.addEventListener('click', () => {
    const name = modalScriptName.value.trim();
    const requireScript = modalRequireScript.value.trim();

    if (!name || /\s/.test(name)) {
      alert('Invalid script name. No spaces allowed.');
      return;
    }
    if (!requireScript) {
      alert('Require script cannot be empty.');
      return;
    }

    const scripts = loadScripts();

    // Check duplicate name
    if (scripts.some(s => s.name === name)) {
      alert('Script name already exists. Choose another.');
      return;
    }

    scripts.push({ name, requireScript, owner: loggedInUser });
    saveScripts(scripts);
    renderScripts();
    modalOverlay.style.display = 'none';

    const luaScript = generateLuaScript(name, requireScript, loggedInUser);
    generatedKeyArea.textContent = luaScript;
    generatedKeyArea.style.display = 'block';
    navigator.clipboard.writeText(luaScript).then(() => {
      alert('Key generated and copied to clipboard!');
    }).catch(() => {
      alert('Key generated! Copy manually.');
    });
  });

  modalSaveScriptBtn.addEventListener('click', () => {
    const name = modalScriptName.value.trim();
    const requireScript = modalRequireScript.value.trim();

    if (!name || /\s/.test(name)) {
      alert('Invalid script name. No spaces allowed.');
      return;
    }
    if (!requireScript) {
      alert('Require script cannot be empty.');
      return;
    }

    const scripts = loadScripts();

    // Check duplicate name except current script
    if (scripts.some((s, i) => s.name === name && i !== editingScriptId)) {
      alert('Script name already exists. Choose another.');
      return;
    }

    const script = scripts[editingScriptId];
    if (script.owner !== loggedInUser) {
      alert('You can only edit your own scripts.');
      return;
    }

    scripts[editingScriptId] = { name, requireScript, owner: loggedInUser };
    saveScripts(scripts);
    renderScripts();
    modalOverlay.style.display = 'none';
  });

  modalDeleteScriptBtn.addEventListener('click', () => {
    if (!confirm('Delete this script? This action cannot be undone.')) return;

    const scripts = loadScripts();
    const script = scripts[editingScriptId];
    if (script.owner !== loggedInUser) {
      alert('You can only delete your own scripts.');
      return;
    }
    scripts.splice(editingScriptId, 1);
    saveScripts(scripts);
    renderScripts();
    modalOverlay.style.display = 'none';
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('loggedInUser');
    window.location.href = 'index.html';
  });

  renderScripts();
})();
</script>
</body>
  </html>
